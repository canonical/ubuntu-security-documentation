Snap Confinement
================

A snap’s confinement level controls the degree of isolation it has from the user’s system. Application developers or packagers can adjust the confinement level to specify in broad terms how much access to system resources an application needs, either for normal use or during development.

There are multiple levels of snap confinement for snaps:

* Strict
* Classic 
* Devmode

See `Snap Confinement <https://snapcraft.io/docs/snap-confinement#p-29237-confinement-levels>`_ for more details.

In order to achieve confinement, snaps utilise multiple Linux isolation and confinement mechanisms. These are:

* AppArmor
* Seccomp
* Device cgroups
* Traditional permissions and Mount namespaces

See `Confinement and isolation mechanisms <https://snapcraft.io/docs/security-policies#p-2741-confinement-and-isolation-mechanisms>`_ for more details.

Confinement Types 
#################

Strict
------

Strict confinement is declared in a snapcraft.yaml through ``confinement: strict``.
This level of confinement utilises all of the confinement mechanisms listed above to ensure the snap executables and data are sandboxed, with limited access.

Interfaces
^^^^^^^^^^

In order to gain access to certain resources on the host system, snap interfaces are used.
Interfaces enable resources from one snap to be shared with another and with the system.
Interfaces are composed by:

* slots: used by snaps or the system (implicit slot) to expose resources
* plugs: used by snaps to consume access resources exposed by a slot

See `Interfaces <https://snapcraft.io/docs/interfaces>`_ for more details.

Classic
-------

Classic confinement is declared in a snapcraft.yaml through ``confinement: classic``.
This level of confinement allows access to the system’s resources in much the same way traditional packages do. Because of this, manual review is required to publish this type of snap.
It is important to note that ``classic`` snaps **do not** run on Ubuntu core systems.

Devmode
-------

Devmode confinement is declared in a snapcraft.yaml through ``confinement: devmode``.
This level of confinement is used during the development of snaps. 
Devmode runs snaps similarly to strictly confined snaps, however, instead of limiting access to the host system resources, it produces a debug output to enable developers to identify what access or interfaces may be needed for the snap to run as strictly confined.

Confinement Mechanisms
######################

AppArmor
--------

AppArmor profiles are generated by snapd for each command in a snap and are used to restrict or allow certain capabilities for each command.
Declaring interfaces in the snap allows the default AppArmor profile to be extended.
`This default profile <https://github.com/canonical/snapd/blob/master/interfaces/apparmor/template.go#L63_>`_ defines a common set of rules that are applied to all bases by default.
For example, when a snap plugs the camera interface, `this profile <https://github.com/canonical/snapd/blob/master/interfaces/builtin/camera.go#L32>`_ is added to extend the default policy.

See :doc:`apparmor` for more details.

Seccomp
-------

Similarly to how AppArmor is used for snaps, Seccomp filters are also generated for each command in a snap.
These allow for processes inside the snap to have syscall filtering. Again, these can be extended through the use of snap interfaces.

See :any:`seccomp-filtering` for more details.

Device cgroups
--------------

Cgroups are used in snaps to resource limit processes running inside the snap.
Udev rules are generated for each command in a snap.
``snapd`` determines whether a device cgroup is used depending on the interfaces used by a snap.
When an interface is used by a snap and that interface uses the udev backend, rules are generated in ``/etc/udev/rules.d/70-snap...`` and tags are added to the devices (hardware) associated with the use of this interface.
If a snap has tagged devices, a cgroup is created in ``/sys/fs/cgroup/devices/`` to allow access to these devices and other common devices (e.g `/dev/null`).

See :doc:`cgroups` for more details.

Traditional permissions and Mount namespaces
--------------------------------------
Processes inside the snap that try to access resources are restricted by the typical file permissions on the system (owner, group, file ACLs, etc).
To further confine access to the system from the processes inside a snap, mount namespaces are also used.
All the processes from the same snap exist in the same mount namespace to ensure isolation from separate snaps in their own mount namespaces.

See `Security Overview <https://snapcraft.io/docs/security-policies#p-2741-security-overview>`_ for more details.